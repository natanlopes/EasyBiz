<!DOCTYPE html>
<html>
<head>
    <title>EasyBiz Chat - Profissional ðŸš€</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #e5ddd5; padding: 20px; }
        #chat-container { max-width: 500px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column; height: 90vh; }
        
        #header { background-color: #075e54; color: white; padding: 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        
        #conversa { flex-grow: 1; overflow-y: scroll; padding: 15px; background: #e5ddd5; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); }
        
        .msg-row { display: flex; margin-bottom: 15px; align-items: flex-end; }
        .msg { padding: 8px 12px; border-radius: 7px; max-width: 70%; position: relative; font-size: 14px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); word-wrap: break-word;}
        
        /* AVATAR */
        .avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; margin-bottom: 2px; border: 1px solid #ccc; background: white; }

        /* LADO DIREITO (EU) */
        .eu-row { justify-content: flex-end; }
        .eu { background-color: #dcf8c6; border-top-right-radius: 0; margin-right: 5px; }
        
        /* LADO ESQUERDO (OUTRO) */
        .outro-row { justify-content: flex-start; }
        .outro { background-color: #ffffff; border-top-left-radius: 0; margin-left: 5px; }
        
        .msg-nome { font-size: 10px; color: #e542a3; font-weight: bold; margin-bottom: 2px; display: block;}
        
        .input-area { padding: 10px; background: #f0f0f0; display: flex; gap: 10px; }
        input { flex-grow: 1; padding: 10px; border: none; border-radius: 20px; outline: none; }
        button { padding: 10px 20px; background-color: #075e54; color: white; border: none; border-radius: 50%; cursor: pointer; }
        
        .setup { margin-bottom: 10px; padding: 10px; background: white; border-radius: 5px; display: flex; gap: 10px; }
    </style>
</head>
<body>

<div class="setup">
    <input type="text" id="tokenJwt" placeholder="Cole o Token JWT aqui..." style="flex-grow: 1;">
    <button onclick="iniciarChat()">Entrar no Chat ðŸ’¬</button>
</div>

<div id="chat-container">
    <div id="header">
        <div class="header-info">EasyBiz Chat</div>
        <span id="status-conn">ðŸ”´</span>
    </div>
    
    <div id="conversa"></div>
    
    <div class="input-area">
        <input type="text" id="conteudo" placeholder="Digite uma mensagem..." onkeydown="if(event.key === 'Enter') enviar()"> 
        <button onclick="enviar()">âž¤</button>
    </div>
</div>

<script>
    var stompClient = null;
    var pedidoId = 1; // âš ï¸ Garanta que o Pedido 1 existe e estÃ¡ ABERTO/EM_ANDAMENTO
    var meuUsuarioId = null;

    // Decodifica o JWT para pegar o ID automaticamente (sem erro manual!)
    function parseJwt (token) {
        var base64Url = token.split('.')[1];
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
    }

    function iniciarChat() {
        var token = document.getElementById('tokenJwt').value;
        if (!token) { alert("âš ï¸ Cole o Token JWT!"); return; }

        // 1. Descobre quem sou eu pelo Token
        try {
            var payload = parseJwt(token);
            meuUsuarioId = payload.sub; // 'sub' geralmente guarda o ID no seu sistema
            console.log("Meu ID extraÃ­do do token: " + meuUsuarioId);
        } catch (e) {
            alert("Token invÃ¡lido!"); return;
        }

        // 2. Carrega HistÃ³rico Antigo (API REST)
        carregarHistorico(token);

        // 3. Conecta WebSocket
        conectarWebSocket(token);
    }

    function carregarHistorico(token) {
        fetch('http://localhost:8080/chat/' + pedidoId, {
            method: 'GET',
            headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(response => response.json())
        .then(mensagens => {
            var div = document.getElementById('conversa');
            div.innerHTML = ""; // Limpa antes de carregar
            mensagens.forEach(msg => mostrarMensagem(msg));
        })
        .catch(err => console.error("Erro ao carregar histÃ³rico:", err));
    }

    function conectarWebSocket(token) {
        if (stompClient !== null) return;
        var socket = new SockJS('http://localhost:8080/ws-chat');
        stompClient = Stomp.over(socket);

        stompClient.connect({ 'Authorization': 'Bearer ' + token }, function () {
            document.getElementById('status-conn').innerText = "ðŸŸ¢ Conectado (ID " + meuUsuarioId + ")";
            
            stompClient.subscribe('/topic/mensagens/' + pedidoId, function (msg) {
                mostrarMensagem(JSON.parse(msg.body));
            });
        }, function(error) { console.log(error); alert("Erro na conexÃ£o WS!"); });
    }

    function enviar() {
        var conteudo = document.getElementById('conteudo').value;
        if(!conteudo) return;
        
        stompClient.send("/app/chat/" + pedidoId, {}, JSON.stringify({'conteudo': conteudo}));
        document.getElementById('conteudo').value = "";
    }

    function mostrarMensagem(msg) {
        var div = document.getElementById('conversa');
        
        // Compara o ID da mensagem com o ID do meu Token
        // Nota: O backend manda msg.remetenteId como nÃºmero, o token extrai string. Usamos == para comparar.
        var souEu = (msg.remetenteId == meuUsuarioId);

        var fotoUrl = msg.remetenteFotoUrl ? msg.remetenteFotoUrl : "https://cdn-icons-png.flaticon.com/512/149/149071.png";
        var imgHtml = `<img src="${fotoUrl}" class="avatar">`;

        var html = `
            <div class="msg-row ${souEu ? 'eu-row' : 'outro-row'}">
                ${!souEu ? imgHtml : ''} 
                <div class="msg ${souEu ? 'eu' : 'outro'}">
                    ${!souEu ? `<span class="msg-nome">${msg.remetenteNome || ''}</span>` : ''}
                    ${msg.conteudo}
                </div>
            </div>
        `;
        div.innerHTML += html;
        div.scrollTop = div.scrollHeight;
    }
</script>
</body>
</html>